{% extends "base.html" %}
{% block content %}
    <h2>Download Status for "{{ anime.title }}"</h2>
    
    <div class="mb-4">
        <a href="/" class="btn btn-secondary">Back to List</a>
    </div>
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Download Progress</h5>
            
            {% if task %}
                <div class="progress mb-3">
                    <div
                    id="progress-bar"
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    role="progressbar"
                    aria-valuenow="{{ task.progress if task else 0 }}"
                    aria-valuemin="0"
                    aria-valuemax="100"
                    data-progress="{{ task.progress if task else 0 }}"
                    style="width: 0%;"
                    >
                    {{ task.progress if task else 0 }}%
                    </div>
                </div>
                <p>Status: <span id="status-text">{{ task.status }}</span></p>
                <p>Processing page <span id="current-page">{{ task.current_page }}</span> of <span id="total-pages">{{ task.total_pages }}</span></p>
                
                {% if task.status == 'running' %}
                <div class="alert alert-info">
                    This process is running in the background. You can leave this page and come back later.
                </div>
                {% elif task.status == 'completed' %}
                <div class="alert alert-success">
                    Download task completed successfully!
                </div>
                {% endif %}
            {% else %}
                <div class="alert alert-warning">
                    No active download task found for this anime.
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
{% if task and task.status == 'running' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusText = document.getElementById('status-text');
    const currentPage = document.getElementById('current-page');
    const totalPages = document.getElementById('total-pages');
    const progressBar = document.querySelector('.progress-bar');

    // init from data-attribute so no Jinja inside style
    if (progressBar) {
        const initial = parseInt(progressBar.dataset.progress || '0', 10);
        progressBar.style.width = initial + '%';
    }
    
    function updateStatus() {
        fetch('/task-status/{{ anime.id }}')
            .then(response => response.json())
            .then(data => {
                if (data.status == 'not_found') {
                    clearInterval(interval);
                    return;
                }
                
                statusText.textContent = data.status;
                currentPage.textContent = data.current_page;
                totalPages.textContent = data.total_pages;
                progressBar.style.width = data.progress + '%';
                progressBar.textContent = data.progress + '%';
                progressBar.setAttribute('aria-valuenow', data.progress);
                
                if (data.status == 'completed') {
                    clearInterval(interval);
                    document.querySelector('.card-body').insertAdjacentHTML(
                        'beforeend',
                        '<div class="alert alert-success mt-3">Download task completed successfully!</div>'
                    );
                }
            })
            .catch(error => console.error('Error:', error));
    }
    
    const interval = setInterval(updateStatus, 5000);
});
</script>
{% endif %}
{% endblock %}